# .github/workflows/update-avatar.yml - –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô
name: üîÑ Auto Avatar Rotator

on:
  schedule:
    # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å UTC
    - cron: '0 0 * * *'
  
  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–æ–≤
  push:
    branches: [ main ]
    paths:
      - 'avatars/**'
      - '!selected_avatar.json'  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª

jobs:
  rotate-avatar:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      
      - name: üé≤ Select random avatar
        id: select
        run: |
          echo "üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞..."
          
          # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          mapfile -t AVATARS < <(find avatars/ -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) ! -name ".gitkeep")
          TOTAL=${#AVATARS[@]}
          
          if [ $TOTAL -eq 0 ]; then
            echo "‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≤–∞—Ç–∞—Ä–æ–≤!"
            echo "üìÅ –°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É avatars/ –∏ –¥–æ–±–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
            exit 1
          fi
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—É –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
          DAY_OF_YEAR=$(date +%j)
          RANDOM_INDEX=$((DAY_OF_YEAR % TOTAL))
          SELECTED="${AVATARS[$RANDOM_INDEX]}"
          SELECTED_NAME=$(basename "$SELECTED")
          
          echo "üé≤ –í—ã–±—Ä–∞–Ω –∞–≤–∞—Ç–∞—Ä –¥–Ω—è: $SELECTED_NAME"
          echo "üìÖ –î–µ–Ω—å –≥–æ–¥–∞: $DAY_OF_YEAR"
          echo "üî¢ –ò–Ω–¥–µ–∫—Å: $RANDOM_INDEX –∏–∑ $TOTAL"
          
          echo "SELECTED_AVATAR=$SELECTED_NAME" >> $GITHUB_ENV
          echo "AVATAR_PATH=$SELECTED" >> $GITHUB_ENV
      
      - name: üì§ Update GitHub profile
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          AVATAR_PATH: ${{ env.AVATAR_PATH }}
        run: |
          echo "üîÑ –û–±–Ω–æ–≤–ª—è—é –∞–≤–∞—Ç–∞—Ä GitHub..."
          
          python3 << 'EOF'
import base64
import requests
import os

avatar_path = os.environ['AVATAR_PATH']
token = os.environ['GH_TOKEN']

# –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
with open(avatar_path, 'rb') as f:
    image_data = f.read()

base64_data = base64.b64encode(image_data).decode('utf-8')

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME —Ç–∏–ø
if avatar_path.lower().endswith('.png'):
    mime_type = 'image/png'
else:
    mime_type = 'image/jpeg'

# –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä
headers = {
    'Authorization': f'token {token}',
    'Accept': 'application/vnd.github.v3+json'
}

data = {
    'avatar_url': f'data:{mime_type};base64,{base64_data}'
}

response = requests.patch(
    'https://api.github.com/user',
    headers=headers,
    json=data,
    timeout=30
)

if response.status_code == 200:
    print('‚úÖ –ê–≤–∞—Ç–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!')
else:
    print(f'‚ùå –û—à–∏–±–∫–∞: {response.status_code}')
    print(response.text)
    exit(1)
EOF
      
      - name: üìù Create summary
        run: |
          echo "## üé≠ –ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–ê–≤–∞—Ç–∞—Ä –¥–Ω—è:** ${{ env.SELECTED_AVATAR }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–í—Ä–µ–º—è:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∞–≤–∞—Ç–∞—Ä—ã](https://github.com/${{ github.repository }}/tree/main/avatars)" >> $GITHUB_STEP_SUMMARY
