# .github/workflows/manual-avatar.yml - –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
name: üß™ Test Avatar (Manual)

on:
  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ selected_avatar.json
  push:
    branches: [ main ]
    paths:
      - 'selected_avatar.json'

jobs:
  test-avatar:
    runs-on: ubuntu-latest
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    if: contains(github.event.head_commit.message, 'test avatar') || contains(github.event.head_commit.message, 'Test avatar')
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          fetch-depth: 0
      
      - name: üîç Read selected avatar
        id: read-config
        run: |
          echo "üìñ –ß–∏—Ç–∞—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
          
          if [ ! -f "selected_avatar.json" ]; then
            echo "‚ùå –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            exit 1
          fi
          
          SELECTED=$(python3 -c "
import json
try:
    with open('selected_avatar.json', 'r') as f:
        config = json.load(f)
    print(config.get('avatar', ''))
except Exception as e:
    print('')
          ")
          
          if [ -z "$SELECTED" ]; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–º—è –∞–≤–∞—Ç–∞—Ä–∞"
            exit 1
          fi
          
          if [ ! -f "avatars/$SELECTED" ]; then
            echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: avatars/$SELECTED"
            exit 1
          fi
          
          echo "‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–π –∞–≤–∞—Ç–∞—Ä: $SELECTED"
          echo "SELECTED_AVATAR=$SELECTED" >> $GITHUB_ENV
      
      - name: üß™ Test avatar
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          SELECTED_AVATAR: ${{ env.SELECTED_AVATAR }}
        run: |
          echo "üß™ –¢–µ—Å—Ç–∏—Ä—É—é –∞–≤–∞—Ç–∞—Ä: $SELECTED_AVATAR"
          
          python3 << 'EOF'
import base64
import requests
import os
import json

avatar_name = os.environ['SELECTED_AVATAR']
token = os.environ['GH_TOKEN']
avatar_path = f"avatars/{avatar_name}"

print(f"üì∏ –¢–µ—Å—Ç–æ–≤—ã–π –∞–≤–∞—Ç–∞—Ä: {avatar_name}")

# –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
with open(avatar_path, 'rb') as f:
    image_data = f.read()

base64_data = base64.b64encode(image_data).decode('utf-8')

if avatar_path.lower().endswith('.png'):
    mime_type = 'image/png'
else:
    mime_type = 'image/jpeg'

# –ü–†–û–í–ï–†–Ø–ï–ú, –Ω–æ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ–º
print("‚úÖ –ê–≤–∞—Ç–∞—Ä –≥–æ—Ç–æ–≤ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é!")
print(f"üìä –†–∞–∑–º–µ—Ä: {len(image_data)} –±–∞–π—Ç")
print(f"üé® –§–æ—Ä–º–∞—Ç: {mime_type}")
print("‚ÑπÔ∏è –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π workflow")

# –û—á–∏—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
test_file = "selected_avatar.json"
if os.path.exists(test_file):
    os.remove(test_file)
    print("üóëÔ∏è –¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –æ—á–∏—â–µ–Ω")

# –°–æ–∑–¥–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
result = {
    "tested_avatar": avatar_name,
    "status": "ready",
    "message": "–ê–≤–∞—Ç–∞—Ä –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ! –î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π workflow.",
    "timestamp": os.environ.get('GITHUB_SHA', '')
}

print(json.dumps(result, indent=2))
EOF
      
      - name: üóëÔ∏è Cleanup and commit
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          echo "üßπ –û—á–∏—â–∞—é —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª..."
          
          # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –∏ –∫–æ–º–º–∏—Ç–∏–º
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          if [ -f "selected_avatar.json" ]; then
            git rm selected_avatar.json
            git commit -m "üßπ Clean test file after testing" || echo "No changes to commit"
            git push || echo "Push not needed"
          fi
      
      - name: üì¢ Create test result
        run: |
          echo "## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–π –∞–≤–∞—Ç–∞—Ä:** ${{ env.SELECTED_AVATAR }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ –ê–≤–∞—Ç–∞—Ä –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:**" >> $GITHUB_STEP_SUMMARY
          echo "1. –û—Å–Ω–æ–≤–Ω–æ–π workflow –æ–±–Ω–æ–≤–∏—Ç –∞–≤–∞—Ç–∞—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ 00:00 UTC" >> $GITHUB_STEP_SUMMARY
          echo "2. –ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –∞–≤–∞—Ç–∞—Ä –≤ –æ—á–µ—Ä–µ–¥—å —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å" >> $GITHUB_STEP_SUMMARY
