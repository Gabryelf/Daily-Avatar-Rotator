name: Test Avatar Change Every Minute from Gist

on:
  schedule:
    - cron: '* * * * *'  # –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
  workflow_dispatch:

jobs:
  update-avatar:
    runs-on: ubuntu-latest
    steps:
      - name: Setup environment
        run: |
          GIST_ID="c09a3c324259654275939f31e0219ac9"
          echo "GIST_ID=$GIST_ID" >> $GITHUB_ENV

      - name: Get avatars list from Gist
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ Gist —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
          curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/gists/$GIST_ID" > gist_info.json
          
          # –ü–∞—Ä—Å–∏–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
          cat gist_info.json | jq -r '.files | keys[]' > avatars.txt
          
          AVATAR_COUNT=$(wc -l < avatars.txt)
          echo "Found $AVATAR_COUNT avatars:"
          cat avatars.txt
          echo "AVATAR_COUNT=$AVATAR_COUNT" >> $GITHUB_ENV
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º raw_url –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ñ–∞–π–ª–∞ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
          FIRST_FILE=$(head -1 avatars.txt)
          RAW_URL=$(cat gist_info.json | jq -r ".files[\"$FIRST_FILE\"].raw_url")
          echo "RAW_URL=$RAW_URL" >> $GITHUB_ENV

      - name: Select random avatar
        run: |
          if [ $AVATAR_COUNT -eq 0 ]; then
            echo "No avatars found!"
            exit 1
          fi
          
          RANDOM_INDEX=$(( RANDOM % AVATAR_COUNT ))
          AVATAR_FILE=$(sed -n "$((RANDOM_INDEX + 1))p" avatars.txt)
          echo "SELECTED_AVATAR=$AVATAR_FILE" >> $GITHUB_ENV
          echo "Selected: $AVATAR_FILE (index: $RANDOM_INDEX)"

      - name: Download selected avatar
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          # –°–∫–∞—á–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ API —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
          curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/gists/$GIST_ID" > gist_data.json
          
          # –ü–æ–ª—É—á–∞–µ–º raw_url –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
          RAW_URL=$(cat gist_data.json | jq -r ".files[\"$SELECTED_AVATAR\"].raw_url")
          echo "Raw URL: $RAW_URL"
          
          # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
          curl -s -H "Authorization: token $GH_TOKEN" "$RAW_URL" -o selected_avatar
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å–∫–∞—á–∞–ª—Å—è
          if [ -s "selected_avatar" ]; then
            echo "‚úÖ Successfully downloaded $SELECTED_AVATAR"
            echo "üìä File size: $(wc -c < selected_avatar) bytes"
          else
            echo "‚ùå Failed to download $SELECTED_AVATAR"
            exit 1
          fi

      - name: Update GitHub avatar
        uses: peaceiris/actions-avatar@v1
        with:
          image-path: './selected_avatar'
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Log timestamp
        run: |
          echo "‚úÖ Avatar updated at: $(date)"
          echo "üñºÔ∏è Used image: $SELECTED_AVATAR"