name: Update Avatar from Gist

on:
  schedule:
    - cron: '* * * * *'  # –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ –ø–æ–ª–Ω–æ—á—å
  workflow_dispatch:      # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  update-avatar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Gist files list
        env:
          GIST_ID: "c09a3c324259654275939f31e0219ac9"
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ Gist
          curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/gists/$GIST_ID" > gist_info.json
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
          cat gist_info.json | jq -r '.files | keys[]' > avatars.txt
          
          echo "üìÅ Files in Gist:"
          cat avatars.txt
          
          AVATAR_COUNT=$(wc -l < avatars.txt)
          echo "üìä Total avatars: $AVATAR_COUNT"
          echo "AVATAR_COUNT=$AVATAR_COUNT" >> $GITHUB_ENV

      - name: Select random avatar
        run: |
          if [ $AVATAR_COUNT -eq 0 ]; then
            echo "‚ùå No avatars found in Gist!"
            exit 1
          fi
          
          mapfile -t AVATAR_FILES < avatars.txt
          RANDOM_INDEX=$(( RANDOM % AVATAR_COUNT ))
          SELECTED_AVATAR="${AVATAR_FILES[$RANDOM_INDEX]}"
          
          echo "SELECTED_AVATAR=$SELECTED_AVATAR" >> $GITHUB_ENV
          echo "üé≤ Selected: $SELECTED_AVATAR"

      - name: Download avatar and update profile
        env:
          GIST_ID: "c09a3c324259654275939f31e0219ac9"
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          # –ü–æ–ª—É—á–∞–µ–º raw_url –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
          curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/gists/$GIST_ID" > gist_data.json
          
          RAW_URL=$(cat gist_data.json | jq -r ".files[\"$SELECTED_AVATAR\"].raw_url")
          echo "üîó Raw URL: $RAW_URL"
          
          # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64
          curl -s -H "Authorization: token $GH_TOKEN" "$RAW_URL" -o avatar_image
          
          # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64
          AVATAR_BASE64=$(base64 -w 0 avatar_image)
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME —Ç–∏–ø –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Ñ–∞–π–ª–∞
          if [[ "$SELECTED_AVATAR" == *.png ]]; then
            MIME_TYPE="image/png"
          elif [[ "$SELECTED_AVATAR" == *.jpg ]] || [[ "$SELECTED_AVATAR" == *.jpeg ]]; then
            MIME_TYPE="image/jpeg"
          else
            MIME_TYPE="image/png"
          fi
          
          echo "üìä File type: $MIME_TYPE"
          echo "üìè File size: $(wc -c < avatar_image) bytes"
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä —á–µ—Ä–µ–∑ GitHub API
          curl -X PATCH \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/user \
            -d "{\"avatar_url\": \"data:$MIME_TYPE;base64,$AVATAR_BASE64\"}"
          
          echo "‚úÖ Avatar update request sent!"

      - name: Completion message
        run: |
          echo "üéâ Avatar updated successfully!"
          echo "üïê Time: $(date)"
          echo "üñºÔ∏è Image: $SELECTED_AVATAR"