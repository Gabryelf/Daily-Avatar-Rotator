# .github/workflows/update-avatar.yml
name: Update Avatar from Repository

on:
  workflow_dispatch:
    inputs:
      avatar_name:
        description: '–ò–º—è —Ñ–∞–π–ª–∞ –∞–≤–∞—Ç–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: avatar1.png)'
        required: false
        default: ''
        type: string
      force_update:
        description: '–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 0 * * *'  # –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ –ø–æ–ª–Ω–æ—á—å UTC
  push:
    branches: [ main ]
    paths:
      - 'selected_avatar.json'  # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞

jobs:
  update-avatar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–π –∞–≤–∞—Ç–∞—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
        id: select-avatar
        run: |
          echo "üîç –ù–∞—á–∏–Ω–∞–µ–º –≤—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞..."
          
          # –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤–∞—Ç–∞—Ä –∏–∑ —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ workflow
          if [ -n "${{ github.event.inputs.avatar_name }}" ]; then
            SELECTED="${{ github.event.inputs.avatar_name }}"
            echo "üéØ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤–∞—Ç–∞—Ä –∏–∑ —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞: $SELECTED"
            MODE="manual_input"
          
          # –í–∞—Ä–∏–∞–Ω—Ç 2: –ê–≤–∞—Ç–∞—Ä –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
          elif [ -f "selected_avatar.json" ]; then
            echo "üìÅ –ù–∞–π–¥–µ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª"
            SELECTED=$(python3 -c "
import json
try:
    with open('selected_avatar.json', 'r') as f:
        config = json.load(f)
    print(config.get('selectedAvatar', ''))
except:
    print('')
            " 2>/dev/null || echo "")
            
            if [ -n "$SELECTED" ] && [ -f "avatars/$SELECTED" ]; then
              echo "üéØ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤–∞—Ç–∞—Ä –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: $SELECTED"
              MODE="config_file"
            else
              echo "‚ö†Ô∏è –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –∞–≤–∞—Ç–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"
              SELECTED=""
              MODE="random"
            fi
          
          # –í–∞—Ä–∏–∞–Ω—Ç 3: –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä
          else
            SELECTED=""
            MODE="random"
          fi
          
          # –ï—Å–ª–∏ –∞–≤–∞—Ç–∞—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω - –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π
          if [ -z "$SELECTED" ]; then
            echo "üé≤ –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –∞–≤–∞—Ç–∞—Ä..."
            mapfile -t AVATARS < <(find avatars/ -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) | sort)
            TOTAL=${#AVATARS[@]}
            
            if [ $TOTAL -eq 0 ]; then
              echo "‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≤–∞—Ç–∞—Ä–æ–≤ –≤ –ø–∞–ø–∫–µ avatars/"
              echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ avatars/:"
              ls -la avatars/ || echo "–ü–∞–ø–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
              exit 1
            fi
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–º–µ—Ä –∑–∞–ø—É—Å–∫–∞ –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
            RUN_NUMBER=${GITHUB_RUN_NUMBER:-$RANDOM}
            INDEX=$((RUN_NUMBER % TOTAL))
            SELECTED="${AVATARS[$INDEX]}"
            SELECTED=$(basename "$SELECTED")
            echo "üé≤ –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä (#${RUN_NUMBER}): $SELECTED"
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
          if [ ! -f "avatars/$SELECTED" ]; then
            echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: avatars/$SELECTED"
            echo "üìÅ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã:"
            ls -la avatars/
            exit 1
          fi
          
          echo "‚úÖ –í—ã–±—Ä–∞–Ω –∞–≤–∞—Ç–∞—Ä: $SELECTED"
          echo "SELECTED_AVATAR=$SELECTED" >> $GITHUB_ENV
          echo "SELECTED_MODE=$MODE" >> $GITHUB_ENV
          echo "avatar_path=avatars/$SELECTED" >> $GITHUB_ENV
      
      - name: –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –ø—Ä–æ—Ñ–∏–ª—è
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          AVATAR_PATH: ${{ env.avatar_path }}
          SELECTED_AVATAR: ${{ env.SELECTED_AVATAR }}
        run: |
          echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä GitHub –ø—Ä–æ—Ñ–∏–ª—è..."
          echo "üìÅ –§–∞–π–ª: $AVATAR_PATH"
          echo "üîß –†–µ–∂–∏–º: $SELECTED_MODE"
          
          python3 << 'EOF'
import base64
import requests
import os
import json
from pathlib import Path

avatar_path = os.environ['AVATAR_PATH']
token = os.environ['GH_TOKEN']
selected_avatar = os.environ['SELECTED_AVATAR']
selected_mode = os.environ.get('SELECTED_MODE', 'unknown')

print(f"üìÑ –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª: {avatar_path}")
print(f"üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {os.path.getsize(avatar_path)} –±–∞–π—Ç")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
if not os.path.exists(avatar_path):
    print(f"‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {avatar_path}")
    exit(1)

# –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
with open(avatar_path, 'rb') as f:
    image_data = f.read()

base64_data = base64.b64encode(image_data).decode('utf-8')

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME —Ç–∏–ø
if avatar_path.lower().endswith('.png'):
    mime_type = 'image/png'
else:
    mime_type = 'image/jpeg'

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
headers = {
    'Authorization': f'token {token}',
    'Accept': 'application/vnd.github.v3+json',
    'Content-Type': 'application/json'
}

data = {
    'avatar_url': f'data:{mime_type};base64,{base64_data}'
}

try:
    print("üåê –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ GitHub API...")
    response = requests.patch(
        'https://api.github.com/user',
        headers=headers,
        json=data,
        timeout=30
    )
    
    if response.status_code == 200:
        print('‚úÖ –ê–≤–∞—Ç–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!')
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        update_info = {
            'avatar': selected_avatar,
            'mode': selected_mode,
            'timestamp': os.environ.get('GITHUB_SHA', ''),
            'workflow_run': os.environ.get('GITHUB_RUN_ID', ''),
            'run_number': os.environ.get('GITHUB_RUN_NUMBER', ''),
            'time': os.environ.get('GITHUB_RUN_ATTEMPT', ''),
            'status': 'success'
        }
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
        history_file = 'avatar_history.json'
        history = []
        
        if os.path.exists(history_file):
            try:
                with open(history_file, 'r') as f:
                    history = json.load(f)
            except:
                history = []
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ –Ω–∞—á–∞–ª–æ
        history.insert(0, update_info)
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∑–∞–ø–∏—Å–µ–π
        history = history[:20]
        
        with open(history_file, 'w') as f:
            json.dump(history, f, indent=2)
        
        # –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –µ–≥–æ
        if selected_mode == 'config_file' and os.path.exists('selected_avatar.json'):
            os.remove('selected_avatar.json')
            print("üóëÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –æ—á–∏—â–µ–Ω")
            
    else:
        print(f'‚ùå –û—à–∏–±–∫–∞ –æ—Ç GitHub API: {response.status_code}')
        print(f'üìÑ –û—Ç–≤–µ—Ç: {response.text}')
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ
        error_info = {
            'avatar': selected_avatar,
            'mode': selected_mode,
            'timestamp': os.environ.get('GITHUB_SHA', ''),
            'error_code': response.status_code,
            'error_text': response.text[:500],
            'status': 'error'
        }
        
        error_file = 'avatar_errors.json'
        errors = []
        
        if os.path.exists(error_file):
            try:
                with open(error_file, 'r') as f:
                    errors = json.load(f)
            except:
                errors = []
        
        errors.insert(0, error_info)
        errors = errors[:10]
        
        with open(error_file, 'w') as f:
            json.dump(errors, f, indent=2)
            
        exit(1)
        
except Exception as e:
    print(f'‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞: {str(e)}')
    exit(1)
EOF
      
      - name: –°–æ–∑–¥–∞–µ–º summary –æ—Ç—á–µ—Ç–∞
        if: always()
        run: |
          echo "## üé≠ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–ø—É—Å–∫–µ" >> $GITHUB_STEP_SUMMARY
          echo "- **–í—Ä–µ–º—è:** $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- **–ê–≤–∞—Ç–∞—Ä:** [${{ env.SELECTED_AVATAR }}](https://github.com/${{ github.repository }}/blob/main/avatars/${{ env.SELECTED_AVATAR }})" >> $GITHUB_STEP_SUMMARY
          echo "- **–†–µ–∂–∏–º –≤—ã–±–æ—Ä–∞:** ${{ env.SELECTED_MODE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **–°—Ç–∞—Ç—É—Å:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó –°—Å—ã–ª–∫–∏" >> $GITHUB_STEP_SUMMARY
          echo "- [üìÅ –ü–∞–ø–∫–∞ —Å –∞–≤–∞—Ç–∞—Ä–∞–º–∏](https://github.com/${{ github.repository }}/tree/main/avatars)" >> $GITHUB_STEP_SUMMARY
          echo "- [üìä –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π](https://github.com/${{ github.repository }}/blob/main/avatar_history.json)" >> $GITHUB_STEP_SUMMARY
          echo "- [üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–æ–≤–∞](${{ github.server_url }}/${{ github.repository }}/actions/workflows/update-avatar.yml)" >> $GITHUB_STEP_SUMMARY
      
      - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
        if: success()
        run: |
          echo "üéâ –ê–≤–∞—Ç–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!"
          echo "üì∏ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Ñ–∞–π–ª: ${{ env.SELECTED_AVATAR }}"
          echo "‚è∞ –í—Ä–µ–º—è: $(date)"
